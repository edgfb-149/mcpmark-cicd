name: Deployment Status Workflow

on:
  push:
    branches:
      - main

jobs:
  pre-deployment:
    name: pre-deployment
    runs-on: ubuntu-latest
    outputs:
      issue_number: ${{ steps.create_issue.outputs.issue_number }}
      previous_sha: ${{ steps.commit_info.outputs.previous_sha }}
      current_sha: ${{ steps.commit_info.outputs.current_sha }}
      package_version: ${{ steps.commit_info.outputs.package_version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

      - name: Run tests
        run: npm test

      - name: Get commit and package information
        id: commit_info
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          PREVIOUS_SHA=$(git rev-parse HEAD~1)
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
          echo "previous_sha=$PREVIOUS_SHA" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT
          echo "Current SHA: $CURRENT_SHA"
          echo "Previous SHA: $PREVIOUS_SHA"
          echo "Package Version: $PACKAGE_VERSION"

      - name: Create deployment tracking issue
        id: create_issue
        uses: actions/github-script@v7
        with:
          script: |
            const currentSha = '${{ steps.commit_info.outputs.current_sha }}';
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Deployment Tracking - ${currentSha.substring(0, 7)}`,
              body: `## Deployment Tracking Issue
              
              **Commit:** ${currentSha}
              **Triggered by:** ${context.payload.pusher.name}
              **Workflow Run:** ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
              
              This issue tracks the deployment status for commit ${currentSha.substring(0, 7)}.`,
              labels: ['deployment', 'in-progress']
            });
            console.log(`Created deployment tracking issue #${issue.data.number}`);
            return issue.data.number;

      - name: Post pre-deployment comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.create_issue.outputs.result }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: 'âœ… **Pre-deployment checks completed**\n\n- Linting passed\n- Tests passed\n- Ready for rollback preparation'
            });

  rollback-preparation:
    name: rollback-preparation
    runs-on: ubuntu-latest
    needs: pre-deployment
    outputs:
      artifact_name: ${{ steps.artifact_info.outputs.artifact_name }}
      checksum: ${{ steps.artifact_info.outputs.checksum }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Get commit information
        id: commit_info
        run: |
          CURRENT_SHA=$(git rev-parse HEAD)
          PREVIOUS_SHA=$(git rev-parse HEAD~1)
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          echo "current_sha=$CURRENT_SHA" >> $GITHUB_OUTPUT
          echo "previous_sha=$PREVIOUS_SHA" >> $GITHUB_OUTPUT
          echo "package_version=$PACKAGE_VERSION" >> $GITHUB_OUTPUT

      - name: Create rollback artifacts directory
        run: mkdir -p rollback-artifacts

      - name: Create executable rollback script
        run: |
          cat > rollback-artifacts/rollback.sh << 'EOF'
          #!/bin/bash
          set -e

          echo "ðŸ”„ Starting rollback process..."

          # Configuration
          PREVIOUS_SHA="${1:-${PREVIOUS_SHA}}"
          CURRENT_SHA="${2:-${CURRENT_SHA}}"

          if [ -z "$PREVIOUS_SHA" ]; then
            echo "âŒ Error: Previous SHA not provided"
            exit 1
          fi

          echo "ðŸ“‹ Rollback Details:"
          echo "   From: $CURRENT_SHA"
          echo "   To:   $PREVIOUS_SHA"

          # Verify git repository
          if [ ! -d ".git" ]; then
            echo "âŒ Error: Not a git repository"
            exit 1
          fi

          # Check if previous commit exists
          if ! git rev-parse --verify "$PREVIOUS_SHA" >/dev/null 2>&1; then
            echo "âŒ Error: Previous commit $PREVIOUS_SHA not found"
            exit 1
          fi

          # Create backup of current state
          echo "ðŸ’¾ Creating backup of current state..."
          BACKUP_DIR="rollback-backup-$(date +%Y%m%d-%H%M%S)"
          mkdir -p "$BACKUP_DIR"
          cp -r package.json package-lock.json src tests "$BACKUP_DIR/" 2>/dev/null || true

          # Perform rollback
          echo "â®ï¸  Rolling back to $PREVIOUS_SHA..."
          git checkout "$PREVIOUS_SHA" -- .

          # Install previous dependencies
          echo "ðŸ“¦ Installing dependencies from previous version..."
          if [ -f "package.json" ]; then
            npm install
          fi

          # Verify installation
          echo "ðŸ” Verifying rollback..."
          if [ -f "package.json" ]; then
            echo "âœ… package.json restored"
          fi

          if [ -f "package-lock.json" ]; then
            echo "âœ… package-lock.json restored"
          fi

          echo ""
          echo "âœ… Rollback completed successfully!"
          echo "   Previous commit: $PREVIOUS_SHA"
          echo "   Backup created at: $BACKUP_DIR"
          echo ""
          echo "ðŸ“ Next steps:"
          echo "   1. Verify application functionality"
          echo "   2. Run tests: npm test"
          echo "   3. Start application: npm start"

          exit 0
          EOF
          chmod +x rollback-artifacts/rollback.sh

      - name: Backup configuration files
        run: |
          cp package.json rollback-artifacts/package.json.backup
          cp package-lock.json rollback-artifacts/package-lock.json.backup 2>/dev/null || echo "No package-lock.json found"

      - name: Create environment template
        run: |
          cat > rollback-artifacts/.env.template << 'EOF'
          # Environment Configuration Template
          # Copy this file to .env and fill in your values

          # Application
          NODE_ENV=production
          PORT=3000

          # Database (if applicable)
          # DATABASE_URL=your_database_url

          # External Services (if applicable)
          # API_KEY=your_api_key

          # Logging
          LOG_LEVEL=info
          EOF

      - name: Create dependency verification script
        run: |
          cat > rollback-artifacts/verify-dependencies.js << 'EOF'
          const fs = require('fs');
          const { execSync } = require('child_process');

          console.log('ðŸ” Verifying dependencies...');

          try {
            // Check if package.json exists
            if (!fs.existsSync('package.json')) {
              console.error('âŒ package.json not found');
              process.exit(1);
            }

            const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
            console.log(`âœ… package.json found - Version: ${pkg.version}`);

            // Check Node.js version
            const nodeVersion = process.version;
            const requiredNodeVersion = pkg.engines?.node;
            
            if (requiredNodeVersion) {
              console.log(`âœ… Node.js version: ${nodeVersion} (required: ${requiredNodeVersion})`);
            } else {
              console.log(`âœ… Node.js version: ${nodeVersion}`);
            }

            // Verify dependencies can be installed
            console.log('ðŸ“¦ Checking dependency installation...');
            try {
              execSync('npm ls --depth=0', { stdio: 'pipe' });
              console.log('âœ… Dependencies installed correctly');
            } catch (error) {
              console.log('âš ï¸  Dependencies may need installation: npm install');
            }

            // Check for common security issues
            const deps = {
              ...pkg.dependencies,
              ...pkg.devDependencies
            };

            const suspiciousPackages = [];
            for (const [name, version] of Object.entries(deps)) {
              if (version.includes('http') && !version.startsWith('http')) {
                suspiciousPackages.push(name);
              }
            }

            if (suspiciousPackages.length > 0) {
              console.log(`âš ï¸  Suspicious package versions found: ${suspiciousPackages.join(', ')}`);
            } else {
              console.log('âœ… No suspicious package versions detected');
            }

            console.log('\nâœ… Dependency verification completed');
          } catch (error) {
            console.error('âŒ Dependency verification failed:', error.message);
            process.exit(1);
          }
          EOF

      - name: Create rollback documentation
        run: |
          cat > rollback-artifacts/ROLLBACK_GUIDE.md << 'EOF'
          # Rollback Guide

          ## Quick Rollback

          If you need to rollback quickly, run:

          \`\`\`bash
          ./rollback.sh
          \`\`\`

          Or with specific SHAs:
          \`\`\`bash
          ./rollback.sh <previous-sha> <current-sha>
          \`\`\`

          ## Manual Rollback Steps

          1. **Stop the application**
             \`\`\`bash
             pm2 stop mcpmark-cicd || pkill -f "node src/app.js"
             \`\`\`

          2. **Checkout previous commit**
             \`\`\`bash
             git checkout <previous-sha> -- .
             \`\`\`

          3. **Install dependencies**
             \`\`\`bash
             npm install
             \`\`\`

          4. **Verify installation**
             \`\`\`bash
             node rollback-artifacts/verify-dependencies.js
             \`\`\`

          5. **Run tests**
             \`\`\`bash
             npm test
             \`\`\`

          6. **Start application**
             \`\`\`bash
             npm start
             \`\`\`

          7. **Verify deployment**
             \`\`\`bash
             npm run health-check
             \`\`\`

          ## Rollback Validation Checklist

          - [ ] Application stopped successfully
          - [ ] Previous commit checked out
          - [ ] Dependencies installed without errors
          - [ ] Tests pass
          - [ ] Application starts successfully
          - [ ] Health check passes
          - [ ] Logs show no errors

          ## Troubleshooting

          ### If rollback fails
          1. Check git status: `git status`
          2. Check for uncommitted changes
          3. Verify you have the correct SHA
          4. Check disk space: `df -h`

          ### If dependencies fail to install
          1. Clear npm cache: `npm cache clean --force`
          2. Delete node_modules: `rm -rf node_modules`
          3. Try installing again: `npm install`

          ## Contact

          For deployment issues, check the GitHub Actions workflow logs.
          EOF

      - name: Create compressed rollback package
        id: artifact_info
        run: |
          ARTIFACT_NAME="rollback-package-${{ steps.commit_info.outputs.current_sha }}"
          tar -czf "${ARTIFACT_NAME}.tar.gz" -C rollback-artifacts .
          CHECKSUM=$(sha256sum "${ARTIFACT_NAME}.tar.gz" | awk '{print $1}')
          echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
          echo "checksum=${CHECKSUM}" >> $GITHUB_OUTPUT
          echo "Created artifact: ${ARTIFACT_NAME}.tar.gz"
          echo "SHA256: ${CHECKSUM}"

      - name: Upload rollback artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact_info.outputs.artifact_name }}
          path: ${{ steps.artifact_info.outputs.artifact_name }}.tar.gz
          retention-days: 30

      - name: Verify rollback script
        run: |
          chmod +x rollback-artifacts/rollback.sh
          bash -n rollback-artifacts/rollback.sh
          echo "âœ… Rollback script syntax valid"

      - name: Verify dependency script
        run: |
          node -c rollback-artifacts/verify-dependencies.js
          echo "âœ… Dependency verification script syntax valid"

      - name: Post rollback plan comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            const previousSha = '${{ steps.commit_info.outputs.previous_sha }}';
            const currentSha = '${{ steps.commit_info.outputs.current_sha }}';
            const packageVersion = '${{ steps.commit_info.outputs.package_version }}';
            const artifactName = '${{ steps.artifact_info.outputs.artifact_name }}';
            const checksum = '${{ steps.artifact_info.outputs.checksum }}';

            const commentBody = `## ðŸ”„ Rollback Plan Ready

            ### Deployment Information
            - âœ… Previous Commit: \`${previousSha}\`
            - âœ… Current Commit: \`${currentSha}\`
            - âœ… Package Version: \`${packageVersion}\`
            - âœ… Artifact: \`${artifactName}\`

            ### Rollback Components Created
            - âœ… Executable rollback script with error handling
            - âœ… Configuration backup (package.json, package-lock.json)
            - âœ… Environment template (.env.template)
            - âœ… Dependency verification script
            - âœ… Comprehensive rollback documentation
            - âœ… Compressed rollback package with SHA256 checksum

            ### Quick Rollback Command
            \`\`\`bash
            # Download and extract the rollback package
            tar -xzf ${artifactName}.tar.gz
            
            # Run the rollback script
            ./rollback.sh
            \`\`\`

            ### Verification Status
            - Rollback script created: true
            - Configuration backup: true
            - Artifact checksum verified: true
            - SHA256: \`${checksum}\`

            ### Next Steps
            The deployment can now proceed. If any issues occur, use the rollback artifacts above to restore the previous version.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });

  post-deployment:
    name: post-deployment
    runs-on: ubuntu-latest
    needs: [pre-deployment, rollback-preparation]
    if: always()
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Remove in-progress label and add completed label
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            
            // Remove in-progress label
            try {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                name: 'in-progress'
              });
            } catch (error) {
              console.log('Label in-progress may have already been removed');
            }
            
            // Add completed label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              labels: ['completed']
            });

      - name: Post deployment completion comment
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            const currentSha = '${{ needs.pre-deployment.outputs.current_sha }}';
            const artifactName = '${{ needs.rollback-preparation.outputs.artifact_name }}';
            const checksum = '${{ needs.rollback-preparation.outputs.checksum }}';

            const commentBody = `## âœ… Deployment Completed Successfully

            **Deployment Details:**
            - Commit: \`${currentSha}\`
            - Workflow Run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}
            - Timestamp: ${new Date().toISOString()}

            **Rollback Prepared:**
            - Artifact: \`${artifactName}\`
            - SHA256: \`${checksum}\`
            - Retention: 30 days

            **Quick Rollback (if needed):**
            \`\`\`bash
            # Download from GitHub Actions artifacts
            # Extract and run:
            ./rollback.sh
            \`\`\`

            The deployment tracking issue will now be closed.`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: commentBody
            });

      - name: Close deployment tracking issue
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ needs.pre-deployment.outputs.issue_number }};
            
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              state: 'closed',
              state_reason: 'completed'
            });
